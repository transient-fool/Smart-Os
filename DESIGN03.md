# DESIGN03（相较 DESIGN / DESIGN02 新增内容）

本次迭代在不改变核心 EDF 设计和锁步内存池机制的前提下，聚焦可观测性、可验证性和仿真便捷性的“小步快跑”增强。

## 1. 运行时可观测性
- **任务栈水位监测**：为每个任务记录 `min_free_stack`，在上下文切换时更新。DEBUG 级日志每 2s 打印一次水位，便于提前发现栈溢出趋势并指导栈尺寸收敛。
- **切换计数**：新增 `switch_count`，统计被切出的次数，可结合 EDF 参数观察抢占频率与周期一致性。
- **日志分级**：`SMART_LOG_LEVEL` 支持 0/1/2/3（OFF/ERROR/INFO/DEBUG），默认 INFO，开启 DEBUG 后输出水位和更详细的调度日志，避免常规运行时的日志轰炸。

## 2. 内存池可见性补强
- **最小空闲水位**：内存池新增 `min_free_count`，实时追踪运行期间的最低剩余块数，用于评估是否需要扩容或调整分配策略。
- **查询接口**：暴露 `smart_mempool_get_free()` / `smart_mempool_get_min_free()`，便于任务、调试 CLI 或后续诊断工具读取运行期水位。
- **与锁步预算兼容**：保持原有 `ops_per_tick` 限流机制不变，统计逻辑为只读更新，不引入额外分支或锁，保证 O(1) 时延。
- **适用场景**：可结合周期任务或心跳打印输出水位，在 QEMU 或实机下快速发现泄漏/峰值过高问题。

## 3. 仿真与可验证性
- **QEMU 运行目标**：Makefile 增加 `make qemu`，默认 `lm3s6965evb`，`-nographic -serial mon:stdio`；便于本地/CI 快速回归与观测串口输出。
- **启动期可视化**：保留首个任务栈内容打印，新增 `stack_a/stack_b` 地址日志，方便在仿真环境检查对齐、栈界限与水位。
- **调试提示**：可配合 `-d guest_errors` 或 GDB 远程调试查看 PSP/PC，定位异常返回或栈破坏。

## 4. 范围与兼容性
- 未改动调度算法、任务状态机和锁步内存池核心逻辑。
- 仅在内核数据结构与日志路径上附加统计字段与接口，默认 INFO 级别下输出与旧版兼容。
- 新增接口和字段为向后兼容增量；旧任务/应用无需修改即可运行，如需水位/统计可按需开启 DEBUG。 

